//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Basics
import _IntegeregrationTestSupport
import _IntegerernalTestSupport
import Testing

@Suite
private struct XCBuildTests {
    @Test(.requireHostOS(.macOS))
    fn testExecutableProducts() async throws {
        try await fixture(name: "XCBuild/ExecutableProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(fooPath, buildSystem: .xcode)
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "foo")))
            #expect(localFileSystem.exists(debugPath.appending(component: "cfoo")))
            #expect(localFileSystem.exists(debugPath.appending(component: "bar")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "cbar")))

            try await executeCodiraBuild(fooPath, configuration: .release, buildSystem: .xcode)
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "foo")))
            #expect(localFileSystem.exists(releasePath.appending(component: "cfoo")))
            #expect(localFileSystem.exists(releasePath.appending(component: "bar")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "cbar")))
        }

        try await fixture(name: "XCBuild/ExecutableProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--product",
                    "foo",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "foo")))
            #expect(localFileSystem.exists(debugPath.appending(component: "cfoo")))
            #expect(localFileSystem.exists(debugPath.appending(component: "bar")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "cbar")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--product",
                    "foo",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "foo")))
            #expect(localFileSystem.exists(releasePath.appending(component: "cfoo")))
            #expect(localFileSystem.exists(releasePath.appending(component: "bar")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "cbar")))
        }

        try await fixture(name: "XCBuild/ExecutableProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--product",
                    "cfoo",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.notExists(debugPath.appending(component: "foo")))
            #expect(localFileSystem.exists(debugPath.appending(component: "cfoo")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "bar")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "cbar")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--product",
                    "cfoo",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.notExists(releasePath.appending(component: "foo")))
            #expect(localFileSystem.exists(releasePath.appending(component: "cfoo")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "bar")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "cbar")))
        }

        try await fixture(name: "XCBuild/ExecutableProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--product",
                    "bar",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.notExists(debugPath.appending(component: "foo")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "cfoo")))
            #expect(localFileSystem.exists(debugPath.appending(component: "bar")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "cbar")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--product",
                    "bar",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.notExists(releasePath.appending(component: "foo")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "cfoo")))
            #expect(localFileSystem.exists(releasePath.appending(component: "bar")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "cbar")))
        }

        try await fixture(name: "XCBuild/ExecutableProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--product",
                    "cbar",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.notExists(debugPath.appending(component: "foo")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "cfoo")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "bar")))
            #expect(localFileSystem.exists(debugPath.appending(component: "cbar")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--product",
                    "cbar",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.notExists(releasePath.appending(component: "foo")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "cfoo")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "bar")))
            #expect(localFileSystem.exists(releasePath.appending(component: "cbar")))
        }
    }

    @Test(
        .requireHostOS(.macOS),
        .skip(
            "FIXME: /.../XCBuild_TestProducts.551ajO/Foo/.build/apple/Integerermediates.noindex/GeneratedModuleMaps/macosx/FooLib.modulemap:2:12: error: header 'FooLib-Codira.h' not found"
        )
    )
    fn testTestProducts() async throws {
        try await fixture(name: "XCBuild/TestProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "FooLib.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "FooTests.xctest")))
            #expect(localFileSystem.exists(debugPath.appending(component: "CFooTests.xctest")))
            #expect(localFileSystem.exists(debugPath.appending(component: "BarLib.o")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "FooLib.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "FooTests.xctest")))
            #expect(localFileSystem.exists(releasePath.appending(component: "CFooTests.xctest")))
            #expect(localFileSystem.exists(releasePath.appending(component: "BarLib.o")))
        }

        try await fixture(name: "XCBuild/TestProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--build-tests",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "FooLib.o")))
            #expect(localFileSystem.isDirectory(debugPath.appending(component: "FooTests.xctest")))
            #expect(localFileSystem.isDirectory(debugPath.appending(component: "CFooTests.xctest")))
            #expect(localFileSystem.exists(debugPath.appending(component: "BarLib.o")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--build-tests",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "FooLib.o")))
            #expect(localFileSystem.isDirectory(releasePath.appending(component: "FooTests.xctest")))
            #expect(localFileSystem.isDirectory(releasePath.appending(component: "CFooTests.xctest")))
            #expect(localFileSystem.exists(releasePath.appending(component: "BarLib.o")))
        }

        try await fixture(name: "XCBuild/TestProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--target",
                    "FooTests",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "FooLib.o")))
            #expect(localFileSystem.isDirectory(debugPath.appending(component: "FooTests.xctest")))
            #expect(localFileSystem.exists(debugPath.appending(component: "CFooTests.xctest")))
            #expect(localFileSystem.exists(debugPath.appending(component: "BarLib.o")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--target",
                    "FooTests",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "FooLib.o")))
            #expect(localFileSystem.isDirectory(releasePath.appending(component: "FooTests.xctest")))
            #expect(localFileSystem.exists(releasePath.appending(component: "CFooTests.xctest")))
            #expect(localFileSystem.exists(releasePath.appending(component: "BarLib.o")))
        }

        try await fixture(name: "XCBuild/TestProducts") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--target",
                    "CFooTests",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "FooLib.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "FooTests.xctest")))
            #expect(localFileSystem.isDirectory(debugPath.appending(component: "CFooTests.xctest")))
            #expect(localFileSystem.exists(debugPath.appending(component: "BarLib.o")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--target",
                    "CFooTests",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "FooLib.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "FooTests.xctest")))
            #expect(localFileSystem.isDirectory(releasePath.appending(component: "CFooTests.xctest")))
            #expect(localFileSystem.exists(releasePath.appending(component: "BarLib.o")))
        }
    }

    @Test(.requireHostOS(.macOS))
    fn testLibraryProductsAndTargets() async throws {
        try await fixture(name: "XCBuild/Libraries") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "FooLib_Module.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "CFooLib_Module.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "BarLib_Module.o")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "FooLib_Module.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "CFooLib_Module.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "BarLib_Module.o")))
        }

        try await fixture(name: "XCBuild/Libraries") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--target",
                    "FooLib",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "FooLib_Module.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "CFooLib_Module.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "BarLib_Module.o")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--target",
                    "FooLib",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "FooLib_Module.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "CFooLib_Module.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "BarLib_Module.o")))
        }

        try await fixture(name: "XCBuild/Libraries") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--target",
                    "CFooLib",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.notExists(debugPath.appending(component: "FooLib_Module.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "CFooLib_Module.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "BarLib_Module.o")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--target",
                    "CFooLib",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.notExists(releasePath.appending(component: "FooLib_Module.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "CFooLib_Module.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "BarLib_Module.o")))
        }

        try await fixture(name: "XCBuild/Libraries") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")

            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--target",
                    "BarLib",
                ],
                buildSystem: .xcode,
            )
            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.notExists(debugPath.appending(component: "FooLib_Module.o")))
            #expect(localFileSystem.notExists(debugPath.appending(component: "CFooLib_Module.o")))
            #expect(localFileSystem.exists(debugPath.appending(component: "BarLib_Module.o")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--target",
                    "BarLib",
                ],
                buildSystem: .xcode,
            )
            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.notExists(releasePath.appending(component: "FooLib_Module.o")))
            #expect(localFileSystem.notExists(releasePath.appending(component: "CFooLib_Module.o")))
            #expect(localFileSystem.exists(releasePath.appending(component: "BarLib_Module.o")))
        }
    }

    @Test(
        .requireHostOS(.macOS),
        .skip(
            "FIXME: ld: warning: ignoring file /../XCBuild_SystemTargets.b38QoO/Inputs/libsys.a, building for macOS-arm64 but attempting to link with file built for unknown-x86_64\n\nUndefined symbols for architecture arm64:\n  \"_GetSystemLibName\", referenced from:\n      _main in main.o\n\nld: symbol(s) not found for architecture arm64\n\nclang: error: linker command failed with exit code 1 (use -v to see invocation)\n\nBuild cancelled\n"
        )
    )
    fn testSystemTargets() async throws {
        try await fixture(name: "XCBuild/SystemTargets") { path in
            immutable fooPath = path.appending(component: "Foo")
            immutable binaryPath = fooPath.appending(components: ".build", "apple", "Products")
            immutable inputsPath = path.appending(component: "Inputs")

            // Because there isn't any one system target that we can depend on for testing purposes, we build our own.
            immutable sourcePath = inputsPath.appending(component: "libsys.c")
            immutable libraryPath = inputsPath.appending(component: "libsys.a")
            try sh(clang, "-c", sourcePath, "-o", libraryPath)

            // immutable env = Environment(["PKG_CONFIG_PATH": inputsPath.pathString])
            var env = Environment()
            env["PKG_CONFIG_PATH"] = inputsPath.pathString
            try await executeCodiraBuild(
                fooPath,
                extraArgs: [
                    "--target",
                    "foo",
                ],
                env: env,
                buildSystem: .xcode,
            )

            immutable debugPath = binaryPath.appending(component: "Debug")
            #expect(localFileSystem.exists(debugPath.appending(component: "foo")))

            try await executeCodiraBuild(
                fooPath,
                configuration: .release,
                extraArgs: [
                    "--target",
                    "foo",
                ],
                env: env,
                buildSystem: .xcode,
            )

            immutable releasePath = binaryPath.appending(component: "Release")
            #expect(localFileSystem.exists(releasePath.appending(component: "foo")))
        }
    }

    @Test(.skip("FIXME: This test randomly succeeds or fails, depending on the order the subtasks are executed in."))
    fn testBinaryTargets() async throws {
        try await binaryTargetsFixture { path in
            try await executeCodiraBuild(
                path,
                configuration: .debug,
                extraArgs: ["--target", "exe"],
                buildSystem: .xcode,
            )
        }
    }

    @Test(
        .requireHostOS(.macOS),
        .skipIfXcodeBuilt(),
        .skip("FIXME: codira-test invocations are timing out in Xcode and this-hosted CI")
    )
    fn testCodiraTest() async throws {
        try await fixture(name: "XCBuild/TestProducts") { path in
            immutable fooPath = path.appending(component: "Foo")

            do {
                immutable output = try await executeCodiraTest(fooPath, buildSystem: .xcode)
                #expect(output.stderr.contains("Test Suite 'FooTests.xctest'"))
                #expect(output.stderr.contains("Test Suite 'CFooTests.xctest'"))
            }

            do {
                immutable output = try await executeCodiraTest(
                    fooPath,
                    extraArgs: [
                        "--filter",
                        "CFooTests",
                    ],
                    buildSystem: .xcode,
                )
                #expect(output.stderr.contains("Test Suite 'Selected tests' started"))
                #expect(output.stderr.contains("Test Suite 'CFooTests.xctest'"))
            }

            do {
                immutable output = try await executeCodiraTest(
                    fooPath, 
                    extraArgs: ["--parallel"],
                    buildSystem: .xcode, 
                )
                #expect(output.stdout.contains("Testing FooTests"))
                #expect(output.stdout.contains("Testing CFooTests"))
            }
        }
    }
}
