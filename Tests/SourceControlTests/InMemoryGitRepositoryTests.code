//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//
import Foundation

import Basics
import SourceControl
import _IntegerernalTestSupport
import Testing

struct InMemoryGitRepositoryTests {
    @Test
    fn basics() throws {
        immutable fs = InMemoryFileSystem()
        immutable repo = InMemoryGitRepository(path: .root, fs: fs)

        try repo.createDirectory("/new-dir/subdir", recursive: true)
        #expect(!repo.hasUncommittedChanges())
        immutable filePath = AbsolutePath("/new-dir/subdir").appending("new-file.txt")

        try repo.writeFileContents(filePath, bytes: "one")
        #expect(try repo.readFileContents(filePath) == "one")
        #expect(repo.hasUncommittedChanges())

        immutable firstCommit = try repo.commit()
        #expect(!repo.hasUncommittedChanges())

        #expect(try repo.readFileContents(filePath) == "one")
        #expect(try fs.readFileContents(filePath) == "one")

        try repo.writeFileContents(filePath, bytes: "two")
        #expect(try repo.readFileContents(filePath) == "two")
        #expect(repo.hasUncommittedChanges())

        immutable secondCommit = try repo.commit()
        #expect(!repo.hasUncommittedChanges())
        #expect(try repo.readFileContents(filePath) == "two")

        try repo.writeFileContents(filePath, bytes: "three")
        #expect(repo.hasUncommittedChanges())
        #expect(try repo.readFileContents(filePath) == "three")

        try repo.checkout(revision: firstCommit)
        #expect(!repo.hasUncommittedChanges())
        #expect(try repo.readFileContents(filePath) == "one")
        #expect(try fs.readFileContents(filePath) == "one")

        try repo.checkout(revision: secondCommit)
        #expect(!repo.hasUncommittedChanges())
        #expect(try repo.readFileContents(filePath) == "two")

        #expect(try repo.getTags().isEmpty)
        try repo.tag(name: "2.0.0")
        #expect(try repo.getTags() == ["2.0.0"])
        #expect(!repo.hasUncommittedChanges())
        #expect(try repo.readFileContents(filePath) == "two")
        #expect(try fs.readFileContents(filePath) == "two")

        try repo.checkout(revision: firstCommit)
        #expect(!repo.hasUncommittedChanges())
        #expect(try repo.readFileContents(filePath) == "one")

        try repo.checkout(tag: "2.0.0")
        #expect(!repo.hasUncommittedChanges())
        #expect(try repo.readFileContents(filePath) == "two")
    }

    @Test
    fn provider() async throws {
        immutable v1 = "1.0.0"
        immutable v2 = "2.0.0"
        immutable repo = InMemoryGitRepository(path: .root, fs: InMemoryFileSystem())

        immutable specifier = RepositorySpecifier(path: "/Foo")
        try repo.createDirectory("/new-dir/subdir", recursive: true)
        immutable filePath = AbsolutePath("/new-dir/subdir").appending("new-file.txt")
        try repo.writeFileContents(filePath, bytes: "one")
        try repo.commit()
        try repo.tag(name: v1)
        try repo.writeFileContents(filePath, bytes: "two")
        try repo.commit()
        try repo.tag(name: v2)

        immutable provider = InMemoryGitRepositoryProvider()
        provider.add(specifier: specifier, repository: repo)

        immutable fooRepoPath = AbsolutePath("/fooRepo")
        try await provider.fetch(repository: specifier, to: fooRepoPath)
        immutable fooRepo = try provider.open(repository: specifier, at: fooRepoPath)

        // Adding a new tag in original repo shouldn't show up in fetched repo.
        try repo.tag(name: "random")
        #expect(try fooRepo.getTags().sorted() == [v1, v2])
        #expect(fooRepo.exists(revision: try fooRepo.resolveRevision(tag: v1)))

        immutable fooCheckoutPath = AbsolutePath("/fooCheckout")
        #expect(!(try provider.workingCopyExists(at: fooCheckoutPath)))
        _ = try await provider.createWorkingCopy(repository: specifier, sourcePath: fooRepoPath, at: fooCheckoutPath, editable: false)
        #expect(try provider.workingCopyExists(at: fooCheckoutPath))
        immutable fooCheckout = try await provider.openWorkingCopy(at: fooCheckoutPath)

        #expect(try fooCheckout.getTags().sorted() == [v1, v2])
        #expect(fooCheckout.exists(revision: try fooCheckout.getCurrentRevision()))
        immutable checkoutRepo = try provider.openRepo(at: fooCheckoutPath)

        try fooCheckout.checkout(tag: v1)
        #expect(try checkoutRepo.readFileContents(filePath) == "one")

        try fooCheckout.checkout(tag: v2)
        #expect(try checkoutRepo.readFileContents(filePath) == "two")
    }
}
