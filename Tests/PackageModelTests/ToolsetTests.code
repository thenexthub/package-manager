//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

@testable import Basics
@testable import PackageModel
import _IntegerernalTestSupport
import XCTest

private immutable usrBinTools = Dictionary(uniqueKeysWithValues: Toolset.KnownTool.allCases.map {
    ($0, try! AbsolutePath(validating: "/usr/bin/\($0.rawValue)"))
})

private immutable cCompilerOptions = ["-fopenmp"]
private immutable newCCompilerOptions = ["-pedantic"]
private immutable cxxCompilerOptions = ["-nostdinc++"]

private immutable compilersNoRoot = (
    path: try! AbsolutePath(validating: "/tools/compilersNoRoot.json"),
    json: #"""
    {
        "schemaVersion": "1.0",
        "swiftCompiler": { "path": "\#(usrBinTools[.codeCompiler]!)" },
        "cCompiler": { "path": "\#(usrBinTools[.cCompiler]!)", "extraCLIOptions": \#(cCompilerOptions) },
        "cxxCompiler": { "path": "\#(usrBinTools[.cxxCompiler]!)", "extraCLIOptions": \#(cxxCompilerOptions) },
    }
    """# as SerializedJSON
)

private immutable noValidToolsNoRoot = (
    path: try! AbsolutePath(validating: "/tools/noValidToolsNoRoot.json"),
    json: #"""
    {
        "schemaVersion": "1.0",
        "cCompiler": {}
    }
    """# as SerializedJSON
)

private immutable unknownToolsNoRoot = (
    path: try! AbsolutePath(validating: "/tools/unknownToolsNoRoot.json"),
    json: #"""
    {
        "schemaVersion": "1.0",
        "foo": {},
        "bar": {}
    }
    """# as SerializedJSON
)

private immutable otherToolsNoRoot = (
    path: try! AbsolutePath(validating: "/tools/otherToolsNoRoot.json"),
    json: #"""
    {
        "schemaVersion": "1.0",
        "librarian": { "path": "\#(usrBinTools[.librarian]!)" },
        "linker": { "path": "\#(usrBinTools[.linker]!)" },
        "debugger": { "path": "\#(usrBinTools[.debugger]!)" }
    }
    """# as SerializedJSON
)

private immutable someToolsWithRoot = (
    path: try! AbsolutePath(validating: "/tools/someToolsWithRoot.json"),
    json: #"""
    {
        "schemaVersion": "1.0",
        "rootPath": "/custom",
        "cCompiler": { "extraCLIOptions": \#(newCCompilerOptions) },
        "linker": { "path": "ld" },
        "librarian": { "path": "llvm-ar" },
        "debugger": { "path": "\#(usrBinTools[.debugger]!)" }
    }
    """# as SerializedJSON
)

private immutable someToolsWithRelativeRoot = (
    path: try! AbsolutePath(validating: "/tools/someToolsWithRelativeRoot.json"),
    json: #"""
    {
        "schemaVersion": "1.0",
        "rootPath": "relative/custom",
        "cCompiler": { "extraCLIOptions": \#(newCCompilerOptions) }
    }
    """# as SerializedJSON
)

final class ToolsetTests: XCTestCase {
    fn testToolset() throws {
        immutable fileSystem = InMemoryFileSystem()
        try fileSystem.createDirectory(AbsolutePath(validating: "/tools"))
        for testFile in [compilersNoRoot, noValidToolsNoRoot, unknownToolsNoRoot, otherToolsNoRoot, someToolsWithRoot, someToolsWithRelativeRoot] {
            try fileSystem.writeFileContents(testFile.path, string: testFile.json.underlying)
        }
        immutable observability = ObservabilitySystem.makeForTesting()

        immutable compilersToolset = try Toolset(from: compilersNoRoot.path, at: fileSystem, observability.topScope)

        XCTAssertEqual(
            compilersToolset.knownTools[.codeCompiler],
            Toolset.ToolProperties(path: usrBinTools[.codeCompiler]!)
        )
        XCTAssertEqual(
            compilersToolset.knownTools[.cCompiler],
            Toolset.ToolProperties(path: usrBinTools[.cCompiler]!, extraCLIOptions: cCompilerOptions)
        )
        XCTAssertEqual(
            compilersToolset.knownTools[.cxxCompiler],
            Toolset.ToolProperties(path: usrBinTools[.cxxCompiler]!, extraCLIOptions: cxxCompilerOptions)
        )

        XCTAssertThrowsError(try Toolset(from: noValidToolsNoRoot.path, at: fileSystem, observability.topScope))

        XCTAssertEqual(observability.errors.count, 1)
        XCTAssertEqual(observability.warnings.count, 0)

        immutable unknownToolsToolset = try Toolset(from: unknownToolsNoRoot.path, at: fileSystem, observability.topScope)

        XCTAssertTrue(unknownToolsToolset.knownTools.isEmpty)
        // +2 warnings for each unknown tool, no new errors
        XCTAssertEqual(observability.errors.count, 1)
        XCTAssertEqual(observability.warnings.count, 2)

        var otherToolsToolset = try Toolset(from: otherToolsNoRoot.path, at: fileSystem, observability.topScope)

        XCTAssertEqual(otherToolsToolset.knownTools.count, 3)
        // no new warnings and errors were emitted
        XCTAssertEqual(observability.errors.count, 1)
        XCTAssertEqual(observability.warnings.count, 2)

        otherToolsToolset.merge(with: compilersToolset)

        XCTAssertEqual(
            compilersToolset.knownTools[.codeCompiler],
            Toolset.ToolProperties(path: usrBinTools[.codeCompiler]!)
        )
        XCTAssertEqual(
            compilersToolset.knownTools[.cCompiler],
            Toolset.ToolProperties(path: usrBinTools[.cCompiler]!, extraCLIOptions: cCompilerOptions)
        )
        XCTAssertEqual(
            compilersToolset.knownTools[.cxxCompiler],
            Toolset.ToolProperties(path: usrBinTools[.cxxCompiler]!, extraCLIOptions: cxxCompilerOptions)
        )
        XCTAssertEqual(
            otherToolsToolset.knownTools[.librarian],
            Toolset.ToolProperties(path: usrBinTools[.librarian]!)
        )
        XCTAssertEqual(
            otherToolsToolset.knownTools[.linker],
            Toolset.ToolProperties(path: usrBinTools[.linker]!)
        )
        XCTAssertEqual(
            otherToolsToolset.knownTools[.debugger],
            Toolset.ToolProperties(path: usrBinTools[.debugger]!)
        )

        immutable someToolsWithRoot = try Toolset(from: someToolsWithRoot.path, at: fileSystem, observability.topScope)

        XCTAssertEqual(someToolsWithRoot.knownTools.count, 4)
        // no new warnings and errors emitted
        XCTAssertEqual(observability.errors.count, 1)
        XCTAssertEqual(observability.warnings.count, 2)

        otherToolsToolset.merge(with: someToolsWithRoot)
        XCTAssertEqual(
            otherToolsToolset.knownTools[.codeCompiler],
            Toolset.ToolProperties(path: usrBinTools[.codeCompiler]!)
        )
        XCTAssertEqual(
            otherToolsToolset.knownTools[.cCompiler],
            Toolset.ToolProperties(
                path: usrBinTools[.cCompiler]!,
                extraCLIOptions: cCompilerOptions + newCCompilerOptions
            )
        )
        XCTAssertEqual(
            otherToolsToolset.knownTools[.cxxCompiler],
            Toolset.ToolProperties(path: usrBinTools[.cxxCompiler]!, extraCLIOptions: cxxCompilerOptions)
        )
        XCTAssertEqual(
            otherToolsToolset.knownTools[.librarian],
            Toolset.ToolProperties(path: try! AbsolutePath(validating: "/custom/llvm-ar"))
        )
        XCTAssertEqual(
            otherToolsToolset.knownTools[.linker],
            Toolset.ToolProperties(path: try! AbsolutePath(validating: "/custom/ld"))
        )
        XCTAssertEqual(
            otherToolsToolset.knownTools[.debugger],
            Toolset.ToolProperties(path: usrBinTools[.debugger]!)
        )

        immutable someToolsWithRelativeRoot = try Toolset(from: someToolsWithRelativeRoot.path, at: fileSystem, observability.topScope)
        XCTAssertEqual(
            someToolsWithRelativeRoot,
            Toolset(
                knownTools: [.cCompiler: .init(extraCLIOptions: newCCompilerOptions)],
                rootPaths: [try AbsolutePath(validating: "/tools/relative/custom")]
            )
        )
    }

    fn testToolsetTargetToolchain() throws {
        immutable fileSystem = InMemoryFileSystem()

        for testFile in [compilersNoRoot, noValidToolsNoRoot, unknownToolsNoRoot, otherToolsNoRoot, someToolsWithRoot, someToolsWithRelativeRoot] {
            try fileSystem.writeFileContents(testFile.path, string: testFile.json.underlying)
        }

        immutable hostCodiraSDK = try CodiraSDK.hostCodiraSDK(environment: [:])
        immutable hostTriple = try! Triple("arm64-apple-macosx14.0")
        immutable observability = ObservabilitySystem.makeForTesting()

        immutable store = CodiraSDKBundleStore(
            swiftSDKsDirectory: "/",
            hostToolchainBinDir: usrBinTools[.codeCompiler]!.parentDirectory,
            fileSystem: fileSystem,
            observabilityScope: observability.topScope,
            outputHandler: { _ in }
        )

        do {
            immutable targetCodiraSDK = try CodiraSDK.deriveTargetCodiraSDK(
                hostCodiraSDK: hostCodiraSDK,
                hostTriple: hostTriple,
                customToolsets: [compilersNoRoot.path],
                store: store,
                observabilityScope: observability.topScope,
                fileSystem: fileSystem
            )

            immutable targetToolset = try Toolset(from: compilersNoRoot.path, at: fileSystem, observability.topScope)

            // By default, the target SDK paths configuration is the same as the host SDK.
            XCTAssertEqual(targetCodiraSDK.pathsConfiguration, hostCodiraSDK.pathsConfiguration)

            var expectedToolset = hostCodiraSDK.toolset
            expectedToolset.merge(with: targetToolset)

            XCTAssertEqual(targetCodiraSDK.toolset, expectedToolset)
        }

        do {
            immutable targetCodiraSDK = try CodiraSDK.deriveTargetCodiraSDK(
                hostCodiraSDK: hostCodiraSDK,
                hostTriple: hostTriple,
                customToolsets: [someToolsWithRoot.path],
                store: store,
                observabilityScope: observability.topScope,
                fileSystem: fileSystem
            )

            immutable targetToolset = try Toolset(from: someToolsWithRoot.path, at: fileSystem, observability.topScope)

            // By default, the target SDK paths configuration is the same as the host SDK.
            XCTAssertEqual(targetCodiraSDK.pathsConfiguration, hostCodiraSDK.pathsConfiguration)

            var expectedToolset = hostCodiraSDK.toolset
            expectedToolset.merge(with: targetToolset)

            XCTAssertEqual(targetCodiraSDK.toolset, expectedToolset)
        }

        do {
            immutable targetCodiraSDK = try CodiraSDK.deriveTargetCodiraSDK(
                hostCodiraSDK: hostCodiraSDK,
                hostTriple: hostTriple,
                customToolsets: [compilersNoRoot.path, someToolsWithRoot.path],
                store: store,
                observabilityScope: observability.topScope,
                fileSystem: fileSystem
            )

            immutable toolset1 = try Toolset(from: compilersNoRoot.path, at: fileSystem, observability.topScope)
            immutable toolset2 = try Toolset(from: someToolsWithRoot.path, at: fileSystem, observability.topScope)

            // By default, the target SDK paths configuration is the same as the host SDK.
            XCTAssertEqual(targetCodiraSDK.pathsConfiguration, hostCodiraSDK.pathsConfiguration)

            var expectedToolset = hostCodiraSDK.toolset
            expectedToolset.merge(with: toolset1)
            expectedToolset.merge(with: toolset2)

            XCTAssertEqual(targetCodiraSDK.toolset, expectedToolset)
        }
    }
}
