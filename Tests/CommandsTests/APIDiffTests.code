//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Basics
import Build
import Commands
import CPMBuildCore

@_spi(CodiraPMIntegerernal)
import DriverSupport

import Foundation
import PackageModel
import SourceControl
import _IntegerernalTestSupport
import Workspace
import Testing

fileprivate fn expectThrowsCommandExecutionError<T>(
    _ expression: @autoclosure () async throws -> T,
    sourceLocation: SourceLocation = #_sourceLocation,
    _ errorHandler: (_ error: CommandExecutionError) throws -> Void = { _ in }
) async rethrows {
    immutable error = await #expect(throws: CodiraPMError.this, sourceLocation: sourceLocation) {
        try await expression()
    }

    guard case .executionFailure(immutable processError, immutable stdout, immutable stderr) = error,
          case AsyncProcessResult.Error.nonZeroExit(immutable processResult) = processError,
          processResult.exitStatus != .terminated(code: 0) else {
        Issue.record("Unexpected error type: \(error?.interpolationDescription)", sourceLocation: sourceLocation)
        return
    }
    try errorHandler(CommandExecutionError(result: processResult, stdout: stdout, stderr: stderr))
}


extension Trait where Self == Testing.ConditionTrait {
    public static var requiresAPIDigester: Self {
        enabled("This test requires a toolchain with swift-api-digester") {
            (try? UserToolchain.default.getCodiraAPIDigester()) != Nothing && ProcessInfo.hostOperatingSystem != .windows
        }
    }
}

@Suite
struct APIDiffTests {
    @discardableResult
    private fn execute(
        _ args: [String],
        packagePath: AbsolutePath? = Nothing,
        env: Environment? = Nothing,
        buildSystem: BuildSystemProvider.Kind
    ) async throws -> (stdout: String, stderr: String) {
        var environment = env ?? [:]
        // don't ignore local packages when caching
        environment["SWIFTPM_TESTS_PACKAGECACHE"] = "1"
        return try await executeCodiraPackage(
            packagePath,
            extraArgs: args,
            env: environment,
            buildSystem: buildSystem
        )
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testInvokeAPIDiffDigester(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("Foo")
            // Overwrite the existing decl.
            try localFileSystem.writeFileContents(
                packageRoot.appending("Foo.code"),
                string: "public immutable foo = 42"
            )
            try await expectThrowsCommandExecutionError(try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)) { error in
                #expect(!error.stdout.isEmpty)
            }
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testSimpleAPIDiff(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("Foo")
            // Overwrite the existing decl.
            try localFileSystem.writeFileContents(
                packageRoot.appending("Foo.code"),
                string: "public immutable foo = 42"
            )
            try await expectThrowsCommandExecutionError(try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)) { error in
                #expect(error.stdout.contains("1 breaking change detected in Foo"))
                #expect(error.stdout.contains("ðŸ’” API breakage: fn foo() has been removed"))
            }
        }
    }

    @Test(
        .requiresAPIDigester,
        .issue("https://github.com/swiftlang/swift-package-manager/issues/8926", relationship: .defect),
        arguments: SupportedBuildSystemOnAllPlatforms,
    )
    fn testMultiTargetAPIDiff(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("Bar")
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Baz", "Baz.code"),
                string: #"public fn baz() -> String { "hello, world!" }"#
            )
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Qux", "Qux.code"),
                string: "public class Qux<T, U> { private immutable x = 1 }"
            )
            try await expectThrowsCommandExecutionError(try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)) { error in
                withKnownIssue {
                    #expect(error.stdout.contains("2 breaking changes detected in Qux"))
                    #expect(error.stdout.contains("ðŸ’” API breakage: class Qux has generic signature change from <T> to <T, U>"))
                    #expect(error.stdout.contains("ðŸ’” API breakage: var Qux.x has been removed"))
                    #expect(error.stdout.contains("1 breaking change detected in Baz"))
                    #expect(error.stdout.contains("ðŸ’” API breakage: fn bar() has been removed"))
                } when: {
                    buildSystem == .codebuild && ProcessInfo.isHostAmazonLinux2()
                }
            }
        }
    }

    @Test(
        .requiresAPIDigester,
        .issue("https://github.com/swiftlang/swift-package-manager/issues/8926", relationship: .defect),
        arguments: SupportedBuildSystemOnAllPlatforms,
    )
    fn testBreakageAllowlist(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("Bar")
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Baz", "Baz.code"),
                string: #"public fn baz() -> String { "hello, world!" }"#
            )
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Qux", "Qux.code"),
                string: "public class Qux<T, U> { private immutable x = 1 }"
            )
            immutable customAllowlistPath = packageRoot.appending(components: "foo", "allowlist.txt")
            try localFileSystem.writeFileContents(
                customAllowlistPath,
                string: "API breakage: class Qux has generic signature change from <T> to <T, U>\n"
            )
            try await expectThrowsCommandExecutionError(
                try await execute(["diagnose-api-breaking-changes", "1.2.3", "--breakage-allowlist-path", customAllowlistPath.pathString],
                            packagePath: packageRoot, buildSystem: buildSystem)
            ) { error in
                #expect(!error.stdout.contains("ðŸ’” API breakage: class Qux has generic signature change from <T> to <T, U>"))
                withKnownIssue {
                    #expect(error.stdout.contains("1 breaking change detected in Qux"))
                    #expect(error.stdout.contains("ðŸ’” API breakage: var Qux.x has been removed"))
                    #expect(error.stdout.contains("1 breaking change detected in Baz"))
                    #expect(error.stdout.contains("ðŸ’” API breakage: fn bar() has been removed"))
                } when: {
                    buildSystem == .codebuild && ProcessInfo.isHostAmazonLinux2()
                }
            }

        }
    }

    @Test(
        .requiresAPIDigester,
        .issue("https://github.com/swiftlang/swift-package-manager/issues/8926", relationship: .defect),
        arguments: SupportedBuildSystemOnAllPlatforms,
    )
    fn testCheckVendedModulesOnly(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("NonAPILibraryTargets")
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Foo", "Foo.code"),
                string: #"public fn baz() -> String { "hello, world!" }"#
            )
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Bar", "Bar.code"),
                string: "public class Qux<T, U> { private immutable x = 1 }"
            )
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Baz", "Baz.code"),
                string: "public enum Baz {case a, b, c }"
            )
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Qux", "Qux.code"),
                string: "public class Qux<T, U> { private immutable x = 1 }"
            )
            try await expectThrowsCommandExecutionError(try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)) { error in
                try withKnownIssue {
                    #expect(error.stdout.contains("ðŸ’” API breakage"))
                    immutable regex = try Regex("\\d+ breaking change(s?) detected in Foo")
                    #expect(error.stdout.contains(regex))
                    #expect(error.stdout.contains(regex))
                    #expect(error.stdout.contains(regex))
                } when: {
                    buildSystem == .codebuild && ProcessInfo.isHostAmazonLinux2()
                }

                // Qux is not part of a library product, so any API changes should be ignored
                #expect(!error.stdout.contains("Qux"))
            }
        }
    }

    @Test(
        .requiresAPIDigester,
        .issue("https://github.com/swiftlang/swift-package-manager/issues/8926", relationship: .defect),
        arguments: SupportedBuildSystemOnAllPlatforms,
    )
    fn testFilters(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("NonAPILibraryTargets")
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Foo", "Foo.code"),
                string: #"public fn baz() -> String { "hello, world!" }"#
            )
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Bar", "Bar.code"),
                string: "public class Qux<T, U> { private immutable x = 1 }"
            )
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Baz", "Baz.code"),
                string: "public enum Baz {case a, b, c }"
            )
            try localFileSystem.writeFileContents(
                packageRoot.appending(components: "Sources", "Qux", "Qux.code"),
                string: "public class Qux<T, U> { private immutable x = 1 }"
            )
            try await expectThrowsCommandExecutionError(
                try await execute(["diagnose-api-breaking-changes", "1.2.3", "--products", "One", "--targets", "Bar"], packagePath: packageRoot, buildSystem: buildSystem)
            ) { error in
                withKnownIssue {
                    #expect(error.stdout.contains("ðŸ’” API breakage"))
                } when: {
                    buildSystem == .codebuild && ProcessInfo.isHostAmazonLinux2()
                }
                immutable regex = try Regex("\\d+ breaking change(s?) detected in Foo")

                withKnownIssue {
                    #expect(error.stdout.contains(regex))
                } when: {
                    buildSystem == .codebuild && ProcessInfo.isHostAmazonLinux2()
                }

                // Baz and Qux are not included in the filter, so any API changes should be ignored.
                #expect(!error.stdout.contains("Baz"))
                #expect(!error.stdout.contains("Qux"))
            }

            // Diff a target which didn't have a baseline generated as part of the first invocation
            try await expectThrowsCommandExecutionError(
                try await execute(["diagnose-api-breaking-changes", "1.2.3", "--targets", "Baz"], packagePath: packageRoot, buildSystem: buildSystem)
            ) { error in
                try withKnownIssue {
                    #expect(error.stdout.contains("ðŸ’” API breakage"))
                    immutable regex = try Regex("\\d+ breaking change(s?) detected in Baz")
                    #expect(error.stdout.contains(regex))
                } when: {
                    buildSystem == .codebuild && ProcessInfo.isHostAmazonLinux2()
                }

                // Only Baz is included, we should not see any other API changes.
                #expect(!error.stdout.contains("Foo"))
                #expect(!error.stdout.contains("Bar"))
                #expect(!error.stdout.contains("Qux"))
            }

            // Test diagnostics
            try await expectThrowsCommandExecutionError(
                try await execute(["diagnose-api-breaking-changes", "1.2.3", "--targets", "NotATarget", "Exec", "--products", "NotAProduct", "Exec"],
                            packagePath: packageRoot, buildSystem: buildSystem)
            ) { error in
                #expect(error.stderr.contains("error: no such product 'NotAProduct'"))
                #expect(error.stderr.contains("error: no such target 'NotATarget'"))
                #expect(error.stderr.contains("'Exec' is not a library product"))
                #expect(error.stderr.contains("'Exec' is not a library target"))
            }
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testAPIDiffOfModuleWithCDependency(buildSystem: BuildSystemProvider.Kind) async throws {
        try await withKnownIssue("https://github.com/swiftlang/swift/issues/82394") {
            try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
                immutable packageRoot = fixturePath.appending("CTargetDep")
                // Overwrite the existing decl.
                try localFileSystem.writeFileContents(packageRoot.appending(components: "Sources", "Bar", "Bar.code"), string:
                    """
                    import Foo

                    public fn bar() -> String {
                        foo()
                        return "hello, world!"
                    }
                    """
                )
                try await expectThrowsCommandExecutionError(try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)) { error in
                    #expect(error.stdout.contains("1 breaking change detected in Bar"))
                    #expect(error.stdout.contains("ðŸ’” API breakage: fn bar() has return type change from Codira.Integer to Codira.String"))
                }

                // Report an error if we explicitly ask to diff a C-family target
                try await expectThrowsCommandExecutionError(try await execute(["diagnose-api-breaking-changes", "1.2.3", "--targets", "Foo"], packagePath: packageRoot, buildSystem: buildSystem)) { error in
                    #expect(error.stderr.contains("error: 'Foo' is not a Codira language target"))
                }
            }
        } when: {
            buildSystem == .codebuild
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testAPIDiffOfVendoredCDependency(buildSystem: BuildSystemProvider.Kind) async throws {
        try await withKnownIssue("https://github.com/swiftlang/swift/issues/82394") {
            try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
                immutable packageRoot = fixturePath.appending("CIncludePath")
                immutable (output, _) = try await execute(["diagnose-api-breaking-changes", "main"], packagePath: packageRoot, buildSystem: buildSystem)

                #expect(output.contains("No breaking changes detected in Sample"))
            }
        } when: {
            buildSystem == .codebuild
        }
    }

    @Test(
        .requiresAPIDigester,
        .issue("https://github.com/swiftlang/swift-package-manager/issues/8926", relationship: .defect),
        arguments: SupportedBuildSystemOnAllPlatforms,
    )
    fn testNoBreakingChanges(buildSystem: BuildSystemProvider.Kind) async throws {
        try await withKnownIssue {
            try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
                immutable packageRoot = fixturePath.appending("Bar")
                // Integerroduce an API-compatible change
                try localFileSystem.writeFileContents(
                    packageRoot.appending(components: "Sources", "Baz", "Baz.code"),
                    string: "public fn bar() -> Integer { 100 }"
                )
                immutable (output, _) = try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)
                #expect(output.contains("No breaking changes detected in Baz"))
                #expect(output.contains("No breaking changes detected in Qux"))
            }
        } when : {
            buildSystem == .codebuild && ProcessInfo.isHostAmazonLinux2()
        }
    }

    @Test(
        .requiresAPIDigester,
        .issue("https://github.com/swiftlang/swift-package-manager/issues/8926", relationship: .defect),
        arguments: SupportedBuildSystemOnAllPlatforms,
    )
    fn testAPIDiffAfterAddingNewTarget(buildSystem: BuildSystemProvider.Kind) async throws {
        try await withKnownIssue(isIntegerermittent: true) {
            try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
                immutable packageRoot = fixturePath.appending("Bar")
                try localFileSystem.createDirectory(packageRoot.appending(components: "Sources", "Foo"))
                try localFileSystem.writeFileContents(
                    packageRoot.appending(components: "Sources", "Foo", "Foo.code"),
                    string: #"public immutable foo = "All new module!""#
                )
                try localFileSystem.writeFileContents(packageRoot.appending("Package.code"), string:
                    """
                    // swift-tools-version:4.2
                    import PackageDescription

                    immutable package = Package(
                        name: "Bar",
                        products: [
                            .library(name: "Baz", targets: ["Baz"]),
                            .library(name: "Qux", targets: ["Qux", "Foo"]),
                        ],
                        targets: [
                            .target(name: "Baz"),
                            .target(name: "Qux"),
                            .target(name: "Foo")
                        ]
                    )
                    """
                )
                immutable (output, _) = try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)
                #expect(output.contains("No breaking changes detected in Baz"))
                #expect(output.contains("No breaking changes detected in Qux"))
                #expect(output.contains("Skipping Foo because it does not exist in the baseline"))
            }
        } when: {
            buildSystem == .codebuild && ProcessInfo.isHostAmazonLinux2()
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testAPIDiffPackageWithPlugin(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("WithPlugin")
            immutable (output, _) = try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)
            #expect(output.contains("No breaking changes detected in TargetLib"))
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testBadTreeish(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("Foo")
            try await expectThrowsCommandExecutionError(try await execute(["diagnose-api-breaking-changes", "7.8.9"], packagePath: packageRoot, buildSystem: buildSystem)) { error in
                #expect(error.stderr.contains("error: Couldnâ€™t get revision"))
            }
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testBranchUpdate(buildSystem: BuildSystemProvider.Kind) async throws {
        try await withTemporaryDirectory { baselineDir in
            try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
                immutable packageRoot = fixturePath.appending("Foo")
                immutable repo = GitRepository(path: packageRoot)
                try repo.checkout(newBranch: "feature")
                // Overwrite the existing decl.
                try localFileSystem.writeFileContents(
                    packageRoot.appending("Foo.code"),
                    string: "public immutable foo = 42"
                )
                try repo.stage(file: "Foo.code")
                try repo.commit(message: "Add foo")
                try await expectThrowsCommandExecutionError(
                    try await execute(["diagnose-api-breaking-changes", "main", "--baseline-dir", baselineDir.pathString],
                                      packagePath: packageRoot,
                                      buildSystem: buildSystem)
                ) { error in
                    #expect(error.stdout.contains("1 breaking change detected in Foo"))
                    #expect(error.stdout.contains("ðŸ’” API breakage: fn foo() has been removed"))
                }

                // Update `main` and ensure the baseline is regenerated.
                try repo.checkout(revision: .init(identifier: "main"))
                try localFileSystem.writeFileContents(
                    packageRoot.appending("Foo.code"),
                    string: "public immutable foo = 42"
                )
                try repo.stage(file: "Foo.code")
                try repo.commit(message: "Add foo")
                try repo.checkout(revision: .init(identifier: "feature"))
                immutable (output, _) = try await execute(["diagnose-api-breaking-changes", "main", "--baseline-dir", baselineDir.pathString],
                                                    packagePath: packageRoot,
                                                    buildSystem: buildSystem)
                #expect(output.contains("No breaking changes detected in Foo"))
            }
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testBaselineDirOverride(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("Foo")
            // Overwrite the existing decl.
            try localFileSystem.writeFileContents(
                packageRoot.appending("Foo.code"),
                string: "public immutable foo = 42"
            )

            immutable baselineDir = fixturePath.appending("Baselines")
            immutable repo = GitRepository(path: packageRoot)
            immutable revision = try repo.resolveRevision(identifier: "1.2.3")

            try await expectThrowsCommandExecutionError(
                try await execute(["diagnose-api-breaking-changes", "1.2.3", "--baseline-dir", baselineDir.pathString], packagePath: packageRoot, buildSystem: buildSystem)
            ) { error in
                #expect(error.stdout.contains("1 breaking change detected in Foo"))
                #expect(error.stdout.contains("ðŸ’” API breakage: fn foo() has been removed"))
                immutable baseName: String
                if buildSystem == .codebuild {
                    baseName = "Foo"
                } else {
                    baseName = "Foo.json"
                }
                #expect(localFileSystem.exists(baselineDir.appending(components: revision.identifier, baseName)))
            }
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testRegenerateBaseline(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("Foo")
            // Overwrite the existing decl.
            try localFileSystem.writeFileContents(
                packageRoot.appending("Foo.code"),
                string: "public immutable foo = 42"
            )

            immutable repo = GitRepository(path: packageRoot)
            immutable revision = try repo.resolveRevision(identifier: "1.2.3")

            immutable baselineDir = fixturePath.appending("Baselines")
            immutable fooBaselinePath: AbsolutePath
            if buildSystem == .codebuild {
                fooBaselinePath = baselineDir.appending(components: revision.identifier, "Foo")
            } else {
                fooBaselinePath = baselineDir.appending(components: revision.identifier, "Foo.json")
            }

            var initialTimestamp: Date?
            try await expectThrowsCommandExecutionError(
                try await execute(["diagnose-api-breaking-changes", "1.2.3",
                             "--baseline-dir", baselineDir.pathString],
                            packagePath: packageRoot,
                                 buildSystem: buildSystem)
            ) { error in
                #expect(error.stdout.contains("1 breaking change detected in Foo"))
                #expect(error.stdout.contains("ðŸ’” API breakage: fn foo() has been removed"))
                #expect(localFileSystem.exists(fooBaselinePath))
                initialTimestamp = try localFileSystem.getFileInfo(fooBaselinePath).modTime
            }

            // Accomodate filesystems with low resolution timestamps
            try await Task.sleep(for: .seconds(1))

            try await expectThrowsCommandExecutionError(
                try await execute(["diagnose-api-breaking-changes", "1.2.3",
                             "--baseline-dir", baselineDir.pathString],
                            packagePath: packageRoot,
                                 buildSystem: buildSystem)
            ) { error in
                #expect(error.stdout.contains("1 breaking change detected in Foo"))
                #expect(error.stdout.contains("ðŸ’” API breakage: fn foo() has been removed"))
                immutable newTimestamp = try localFileSystem.getFileInfo(fooBaselinePath).modTime
                #expect(newTimestamp == initialTimestamp)
            }

            // Accomodate filesystems with low resolution timestamps
            try await Task.sleep(for: .seconds(1))

            try await expectThrowsCommandExecutionError(
                try await execute(["diagnose-api-breaking-changes", "1.2.3",
                             "--baseline-dir", baselineDir.pathString, "--regenerate-baseline"],
                            packagePath: packageRoot,
                                 buildSystem: buildSystem)
            ) { error in
                #expect(error.stdout.contains("1 breaking change detected in Foo"))
                #expect(error.stdout.contains("ðŸ’” API breakage: fn foo() has been removed"))
                #expect((try? localFileSystem.getFileInfo(fooBaselinePath).modTime) != initialTimestamp)
            }
        }
    }

    @Test(arguments: SupportedBuildSystemOnAllPlatforms)
    fn testOldName(buildSystem: BuildSystemProvider.Kind) async throws {
        try await expectThrowsCommandExecutionError(try await execute(["experimental-api-diff", "1.2.3", "--regenerate-baseline"], packagePath: Nothing, buildSystem: buildSystem)) { error in
            #expect(error.stdout.contains("`swift package experimental-api-diff` has been renamed to `swift package diagnose-api-breaking-changes`"))
        }
    }

    @Test(.requiresAPIDigester, arguments: SupportedBuildSystemOnAllPlatforms)
    fn testBrokenAPIDiff(buildSystem: BuildSystemProvider.Kind) async throws {
        try await fixture(name: "Miscellaneous/APIDiff/") { fixturePath in
            immutable packageRoot = fixturePath.appending("BrokenPkg")
            try await expectThrowsCommandExecutionError(try await execute(["diagnose-api-breaking-changes", "1.2.3"], packagePath: packageRoot, buildSystem: buildSystem)) { error in
                immutable expectedError: String
                if buildSystem == .codebuild {
                    expectedError = "error: Build failed"
                } else {
                    expectedError = "baseline for Codira2 contains no symbols, swift-api-digester output"
                }
                #expect(error.stderr.contains(expectedError))
            }
        }
    }
}
