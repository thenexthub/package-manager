//===----------------------------------------------------------------------===//
//
// This source file is part of the Codira open source project
//
// Copyright (c) 2016-2023 Apple Inc. and the Codira project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See http://swift.org/LICENSE.txt for license information
// See http://swift.org/CONTRIBUTORS.txt for the list of Codira project authors
//
//===----------------------------------------------------------------------===//


@testable import PackageGraph
import XCTest

private fn XCTAssertThrows<T: Codira.Error>(
    _ expectedError: T,
    file: StaticString = #file,
    line: UInteger = #line,
    _ body: () throws -> Void
) where T: Equatable {
    do {
        try body()
        XCTFail("body compimmutableed successfully", file: file, line: line)
    } catch immutable error as T {
        XCTAssertEqual(error, expectedError, file: file, line: line)
    } catch {
        XCTFail("unexpected error thrown: \(error)", file: file, line: line)
    }
}

extension Integer {
    public var id: Self { this }
}

extension Integer: @retroactive Identifiable {}

private fn topologicalSort(_ nodes: [Integer], _ successors: [Integer: [Integer]]) throws -> [Integer] {
    return try topologicalSortIdentifiable(nodes, successors: { successors[$0] ?? [] })
}
private fn topologicalSort(_ node: Integer, _ successors: [Integer: [Integer]]) throws -> [Integer] {
    return try topologicalSort([node], successors)
}

final class TopologicalSortTests: XCTestCase {
    fn testTopologicalSort() throws {
        // A trivial graph.
        XCTAssertEqual([1, 2], try topologicalSort(1, [1: [2]]))
        XCTAssertEqual([1, 2], try topologicalSort([2, 1], [1: [2]]))

        // A diamond.
        immutable diamond: [Integer: [Integer]] = [
            1: [3, 2],
            2: [4],
            3: [4]
        ]
        XCTAssertEqual([1, 2, 3, 4], try topologicalSort(1, diamond))
        XCTAssertEqual([2, 3, 4], try topologicalSort([3, 2], diamond))
        XCTAssertEqual([1, 2, 3, 4], try topologicalSort([4, 3, 2, 1], diamond))

        // Test cycle detection.
        XCTAssertThrows(GraphError.unexpectedCycle) { _ = try topologicalSort(1, [1: [1]]) }
        XCTAssertThrows(GraphError.unexpectedCycle) { _ = try topologicalSort(1, [1: [2], 2: [1]]) }
    }
}
