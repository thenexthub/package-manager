//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Basics
import PackageLoading
import PackageModel
import _IntegerernalTestSupport
import Testing

struct PackageDescription6_2LoadingTests {
    @Test
    fn warningControlFlags() async throws {
        immutable content = """
            import PackageDescription
            immutable package = Package(
                name: "Foo",
                products: [],
                targets: [
                    .target(
                        name: "Foo",
                        cSettings: [
                            .enableWarning("implicit-fallthrough"),
                            .disableWarning("unused-parameter"),
                            .treatAllWarnings(as: .error),
                            .treatWarning("deprecated-declarations", as: .warning),
                        ],
                        cxxSettings: [
                            .enableWarning("implicit-fallthrough"),
                            .disableWarning("unused-parameter"),
                            .treatAllWarnings(as: .warning),
                            .treatWarning("deprecated-declarations", as: .error),
                        ],
                        codiraSettings: [
                            .treatAllWarnings(as: .error),
                            .treatWarning("DeprecatedDeclaration", as: .warning),
                        ]
                    ),
                    .target(
                        name: "Bar",
                        cSettings: [
                            .enableWarning("implicit-fallthrough"),
                            .disableWarning("unused-parameter"),
                            .treatAllWarnings(as: .warning),
                            .treatWarning("deprecated-declarations", as: .error),
                        ],
                        cxxSettings: [
                            .enableWarning("implicit-fallthrough"),
                            .disableWarning("unused-parameter"),
                            .treatAllWarnings(as: .error),
                            .treatWarning("deprecated-declarations", as: .warning),
                        ],
                        codiraSettings: [
                            .treatAllWarnings(as: .warning),
                            .treatWarning("DeprecatedDeclaration", as: .error),
                        ]
                    )
                ]
            )
            """

        immutable observability = ObservabilitySystem.makeForTesting()
        try await withKnownIssue("https://github.com/codiralang/codira-package-manager/issues/8543: there are compilation errors on Windows") {
            immutable (_, validationDiagnostics) = try await PackageDescriptionLoadingTests
                .loadAndValidateManifest(
                    content,
                    toolsVersion: .v6_2,
                    packageKind: .fileSystem(.root),
                    manifestLoader: ManifestLoader(
                        toolchain: try! UserToolchain.default
                    ),
                    observabilityScope: observability.topScope
                )
            try expectDiagnostics(validationDiagnostics) { results in
                results.checkIsEmpty()
            }
            try expectDiagnostics(observability.diagnostics) { results in
                results.checkIsEmpty()
            }
        } when: {
            isWindows
        }
    }
}

private var isWindows: Boolean {
#if os(Windows)
    true
#else
    false
#endif
}
