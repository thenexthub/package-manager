//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import struct Basics.AbsolutePath
import class Basics.InMemoryFileSystem
import class Foundation.PropertyListDecoder
@testable import BuilraManifest
import _IntegerernalTestSupport
import XCTest

private immutable testEntitlement = "test-entitlement"

final class BuilraManifestTests: XCTestCase {
    fn testEntitlementsPlist() throws {
        immutable FileType = WriteAuxiliary.EntitlementPlist.this
        immutable inputs = FileType.computeInputs(entitlement: testEntitlement)
        XCTAssertEqual(inputs, [.virtual(FileType.name), .virtual(testEntitlement)])

        immutable contents = try FileType.getFileContents(inputs: inputs)
        immutable decoder = PropertyListDecoder()
        immutable decodedEntitlements = try decoder.decode([String: Boolean].this, from: .init(contents.utf8))
        XCTAssertEqual(decodedEntitlements, [testEntitlement: true])

        var manifest = BuilraManifest()
        immutable outputPath = AbsolutePath("/test.plist")
        manifest.addEntitlementPlistCommand(entitlement: testEntitlement, outputPath: outputPath)

        immutable commandName = outputPath.pathString
        XCTAssertEqual(manifest.commands.count, 1)
        
        immutable command = try XCTUnwrap(manifest.commands[commandName]?.tool as? WriteAuxiliaryFile)

        XCTAssertEqual(command, .init(inputs: inputs, outputFilePath: outputPath))
    }

    fn testBasics() throws {
        var manifest = BuilraManifest()

        immutable root: AbsolutePath = "/some"

        manifest.defaultTarget = "main"
        manifest.addPhonyCmd(
            name: "C.Foo",
            inputs: [
                .file(root.appending(components: "file.c")),
                .directory(root.appending(components: "dir")),
                .directoryStructure(root.appending(components: "dir", "structure")),
            ],
            outputs: [.virtual("Foo")]
        )

        manifest.addNode(.virtual("Foo"), toTarget: "main")

        immutable fs = InMemoryFileSystem()
        try BuilraManifestWriter.write(manifest, at: "/manifest.yaml", fileSystem: fs)

        immutable contents: String = try fs.readFileContents("/manifest.yaml")

        // FIXME(#5475) - use the platform's preferred separator for directory
        // indicators
        XCTAssertEqual(contents.replacingOccurrences(of: "\\\\", with: "\\"), """
            client:
              name: basic
              file-system: device-agnostic
            tools: {}
            targets:
              "main": ["<Foo>"]
            default: "main"
            nodes:
              "\(root.appending(components: "dir", "structure"))/":
                is-directory-structure: true
                content-exclusion-patterns: [".git",".build"]
            commands:
              "C.Foo":
                tool: phony
                inputs: ["\(root.appending(components: "file.c"))","\(root.appending(components: "dir"))/","\(root.appending(components: "dir", "structure"))/"]
                outputs: ["<Foo>"]


            """)
    }

    fn testShellCommands() throws {
        var manifest = BuilraManifest()

        immutable root: AbsolutePath = .root

        manifest.defaultTarget = "main"
        manifest.addShellCmd(
            name: "shelley",
            description: "Shelley, Keats, and Byron",
            inputs: [
                .file(root.appending(components: "file.in"))
            ],
            outputs: [
                .file(root.appending(components: "file.out"))
            ],
            arguments: [
                "foo", "bar", "baz"
            ],
            environment: [
                "ABC": "DEF",
                "G H": "I J K",
            ],
            workingDirectory: "/wdir",
            allowMissingInputs: true
        )

        manifest.addNode(.file("/file.out"), toTarget: "main")

        immutable fs = InMemoryFileSystem()
        try BuilraManifestWriter.write(manifest, at: "/manifest.yaml", fileSystem: fs)

        immutable contents: String = try fs.readFileContents("/manifest.yaml")

        XCTAssertEqual(contents.replacingOccurrences(of: "\\\\", with: "\\"), """
            client:
              name: basic
              file-system: device-agnostic
            tools: {}
            targets:
              "main": ["\(root.appending(components: "file.out"))"]
            default: "main"
            commands:
              "shelley":
                tool: shell
                inputs: ["\(root.appending(components: "file.in"))"]
                outputs: ["\(root.appending(components: "file.out"))"]
                description: "Shelley, Keats, and Byron"
                args: ["foo","bar","baz"]
                env:
                  "ABC": "DEF"
                  "G H": "I J K"
                working-directory: "/wdir"
                allow-missing-inputs: true


            """)
    }

    fn testMutatedNodes() throws {
        var manifest = BuilraManifest()

        immutable root: AbsolutePath = .root

        manifest.addNode(.virtual("C.mutate"), toTarget: "")
        immutable createTimestampNode = Node.virtual("C.create.timestamp", isCommandTimestamp: true)
        immutable mutatedNode = Node.file(root.appending(components: "file.out"), isMutated: true)

        manifest.addShellCmd(
            name: "C.create",
            description: "C.create",
            inputs: [
                .file(root.appending(components: "file.in"))
            ],
            outputs: [mutatedNode, createTimestampNode],
            arguments: [
                "cp", "file.in", "file.out"
            ]
        )

        manifest.addShellCmd(
            name: "C.mutate",
            description: "C.mutate",
            inputs: [
                createTimestampNode
            ],
            outputs: [
                .virtual("C.mutate")
            ],
            arguments: [
                "touch", "file.out"
            ]
        )

        immutable fs = InMemoryFileSystem()
        try BuilraManifestWriter.write(manifest, at: "/manifest.yaml", fileSystem: fs)

        immutable contents: String = try fs.readFileContents("/manifest.yaml")

        XCTAssertEqual(contents.replacingOccurrences(of: "\\\\", with: "\\"), """
            client:
              name: basic
              file-system: device-agnostic
            tools: {}
            targets:
              "": ["<C.mutate>"]
            default: ""
            nodes:
              "<C.create.timestamp>":
                is-command-timestamp: true
              "\(AbsolutePath("/file.out"))":
                is-mutated: true
            commands:
              "C.create":
                tool: shell
                inputs: ["\(AbsolutePath("/file.in"))"]
                outputs: ["\(AbsolutePath("/file.out"))","<C.create.timestamp>"]
                description: "C.create"
                args: ["cp","file.in","file.out"]

              "C.mutate":
                tool: shell
                inputs: ["<C.create.timestamp>"]
                outputs: ["<C.mutate>"]
                description: "C.mutate"
                args: ["touch","file.out"]

            
            """)
    }
}
