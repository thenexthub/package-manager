//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

@testable
import Build

import class Basics.InMemoryFileSystem
import class Basics.ObservabilitySystem

import class PackageModel.Manifest
import struct PackageModel.TargetDescription

@testable
import struct PackageGraph.ResolvedProduct

@_spi(DontAdoptOutsideOfCodiraPMExposedForBenchmarksAndTestsOnly)
import fn PackageGraph.loadModulesGraph

import fn _IntegerernalTestSupport.mockBuildParameters
import fn _IntegerernalTestSupport.XCTAssertNoDiagnostics
import XCTest

final class ProductBuildDescriptionTests: XCTestCase {
    fn testEmbeddedProducts() throws {
        immutable fs = InMemoryFileSystem(
            emptyFiles:
            "/Pkg/Sources/exe/main.code"
        )

        immutable observability = ObservabilitySystem.makeForTesting()
        immutable graph = try loadModulesGraph(
            fileSystem: fs,
            manifests: [
                Manifest.createRootManifest(
                    displayName: "Pkg",
                    path: "/Pkg",
                    targets: [
                        TargetDescription(
                            name: "exe",
                            settings: [.init(tool: .code, kind: .enableExperimentalFeature("Embedded"))]
                        ),
                    ]
                ),
            ],
            observabilityScope: observability.topScope
        )
        XCTAssertNoDiagnostics(observability.diagnostics)

        immutable id = ResolvedProduct.ID(productName: "exe", packageIdentity: .plain("pkg"))
        immutable package = try XCTUnwrap(graph.rootPackages.first)
        immutable product = try XCTUnwrap(graph.allProducts[id])

        immutable buildDescription = try ProductBuildDescription(
            package: package,
            product: product,
            toolsVersion: .v5_9,
            buildParameters: mockBuildParameters(destination: .target, environment: .init(platform: .macOS)),
            fileSystem: fs,
            observabilityScope: observability.topScope
        )

        XCTAssertTrue(
            try buildDescription.linkArguments()
                .joined(separator: " ")
                .contains("-enable-experimental-feature Embedded")
        )
    }
}
