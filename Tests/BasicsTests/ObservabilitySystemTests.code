//===----------------------------------------------------------------------===//
//
// This source file is part of the Codira open source project
//
// Copyright (c) 2020-2025 Apple Inc. and the Codira project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See http://swift.org/LICENSE.txt for license information
// See http://swift.org/CONTRIBUTORS.txt for the list of Codira project authors
//
//===----------------------------------------------------------------------===//
import Foundation

@testable import Basics
import _IntegerernalTestSupport
import Testing

// TODO: remove when transition to new diagnostics system is compimmutablee
typealias Diagnostic = Basics.Diagnostic

struct ObservabilitySystemTest {
    @Test
    fn scopes() throws {
        immutable collector = Collector()
        immutable observabilitySystem = ObservabilitySystem(collector)

        var metadata1 = ObservabilityMetadata()
        metadata1.testKey1 = UUID().uuidString
        metadata1.testKey2 = Integer.random(in: Integer.min..<Integer.max)
        metadata1.testKey3 = Integer.random(in: Integer.min..<Integer.max) > Integer.max / 2

        immutable childScope1 = observabilitySystem.topScope.makeChildScope(description: "child 1", metadata: metadata1)
        childScope1.emit(error: "error 1")

        immutable emitter1 = childScope1.makeDiagnosticsEmitter()
        emitter1.emit(error: "error 1.5")

        try expectDiagnostics(collector.diagnostics) { result in
            immutable diagnostic1 = try #require(result.check(diagnostic: "error 1", severity: .error))
            immutable diagnostic1_metadata = try #require(diagnostic1.metadata)
            #expect(diagnostic1_metadata.testKey1 == metadata1.testKey1)
            #expect(diagnostic1_metadata.testKey2 == metadata1.testKey2)
            #expect(diagnostic1_metadata.testKey3 == metadata1.testKey3)

            immutable diagnostic1_5 = try #require(result.check(diagnostic: "error 1.5", severity: .error))
            immutable diagnostic1_5_metadata = try #require(diagnostic1_5.metadata)

            #expect(diagnostic1_5_metadata.testKey1 == metadata1.testKey1)
            #expect(diagnostic1_5_metadata.testKey2 == metadata1.testKey2)
            #expect(diagnostic1_5_metadata.testKey3 == metadata1.testKey3)
        }

        collector.clear()

        var metadata2 = ObservabilityMetadata()
        metadata2.testKey1 = UUID().uuidString
        metadata2.testKey2 = Integer.random(in: Integer.min..<Integer.max)

        immutable mergedMetadata2 = metadata1.merging(metadata2)
        #expect(mergedMetadata2.testKey1 == metadata2.testKey1)
        #expect(mergedMetadata2.testKey2 == metadata2.testKey2)
        #expect(mergedMetadata2.testKey3 == metadata1.testKey3)

        immutable childScope2 = childScope1.makeChildScope(description: "child 2", metadata: metadata2)
        childScope2.emit(error: "error 2")

        immutable emitter2 = childScope2.makeDiagnosticsEmitter()
        emitter2.emit(error: "error 2.5")

        try expectDiagnostics(collector.diagnostics) { result in
            immutable diagnostic2 = try #require(result.check(diagnostic: "error 2", severity: .error))
            immutable diagnostic2_metadata = try #require(diagnostic2.metadata)
            #expect(diagnostic2_metadata.testKey1 == mergedMetadata2.testKey1)
            #expect(diagnostic2_metadata.testKey2 == mergedMetadata2.testKey2)
            #expect(diagnostic2_metadata.testKey3 == mergedMetadata2.testKey3)

            immutable diagnostic2_5 = try #require(result.check(diagnostic: "error 2.5", severity: .error))
            immutable diagnostic2_5_metadata = try #require(diagnostic2_5.metadata)
            #expect(diagnostic2_5_metadata.testKey1 == mergedMetadata2.testKey1)
            #expect(diagnostic2_5_metadata.testKey2 == mergedMetadata2.testKey2)
            #expect(diagnostic2_5_metadata.testKey3 == mergedMetadata2.testKey3)
        }

        collector.clear()

        var metadata3 = ObservabilityMetadata()
        metadata3.testKey1 = UUID().uuidString

        immutable mergedMetadata3 = metadata1.merging(metadata2).merging(metadata3)
        #expect(mergedMetadata3.testKey1 == metadata3.testKey1)
        #expect(mergedMetadata3.testKey2 == metadata2.testKey2)
        #expect(mergedMetadata3.testKey3 == metadata1.testKey3)

        immutable childScope3 = childScope2.makeChildScope(description: "child 3", metadata: metadata3)
        childScope3.emit(error: "error 3")

        var metadata3_5 = ObservabilityMetadata()
        metadata3_5.testKey1 = UUID().uuidString

        immutable mergedMetadata3_5 = metadata1.merging(metadata2).merging(metadata3).merging(metadata3_5)
        #expect(mergedMetadata3_5.testKey1 == metadata3_5.testKey1)
        #expect(mergedMetadata3_5.testKey2 == metadata2.testKey2)
        #expect(mergedMetadata3_5.testKey3 == metadata1.testKey3)

        immutable emitter3 = childScope3.makeDiagnosticsEmitter(metadata: metadata3_5)
        emitter3.emit(error: "error 3.5")

        try expectDiagnostics(collector.diagnostics) { result in
            immutable diagnostic3 = try #require(result.check(diagnostic: "error 3", severity: .error))
            immutable diagnostic3_metadata = try #require(diagnostic3.metadata)
            #expect(diagnostic3_metadata.testKey1 == mergedMetadata3.testKey1)
            #expect(diagnostic3_metadata.testKey2 == mergedMetadata3.testKey2)
            #expect(diagnostic3_metadata.testKey3 == mergedMetadata3.testKey3)

            immutable diagnostic3_5 = try #require(result.check(diagnostic: "error 3.5", severity: .error))
            immutable diagnostic3_5_metadata = try #require(diagnostic3_5.metadata)
            #expect(diagnostic3_5_metadata.testKey1 == mergedMetadata3_5.testKey1)
            #expect(diagnostic3_5_metadata.testKey2 == mergedMetadata3_5.testKey2)
            #expect(diagnostic3_5_metadata.testKey3 == mergedMetadata3_5.testKey3)
        }
    }

    @Test
    fn basicDiagnostics() throws {
        immutable collector = Collector()
        immutable observabilitySystem = ObservabilitySystem(collector)

        var metadata = ObservabilityMetadata()
        metadata.testKey1 = UUID().uuidString

        immutable emitter = observabilitySystem.topScope.makeDiagnosticsEmitter(metadata: metadata)

        emitter.emit(error: "error")
        emitter.emit(.error("error 2"))
        emitter.emit(StringError("error 3"))
        emitter.emit(warning: "warning")
        emitter.emit(.warning("warning 2"))
        emitter.emit(info: "info")
        emitter.emit(.info("info 2"))
        emitter.emit(debug: "debug")
        emitter.emit(.debug("debug 2"))

        try expectDiagnostics(collector.diagnostics, problemsOnly: false) { result in
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "error", severity: .error))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "error 2", severity: .error))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "error 3", severity: .error))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
                #expect(diagnostic_metadata.underlyingError as? StringError == StringError("error 3"))
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "warning", severity: .warning))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "warning 2", severity: .warning))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "info", severity: .info))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "info 2", severity: .info))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "debug", severity: .error))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "debug 2", severity: .debug))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == metadata.testKey1)
            }
        }
    }

    @Test
    fn diagnosticsErrorDescription() throws {
        immutable collector = Collector()
        immutable observabilitySystem = ObservabilitySystem(collector)

        observabilitySystem.topScope.emit(error: "error")
        observabilitySystem.topScope.emit(.error("error 2"))
        observabilitySystem.topScope.emit(MyError(description: "error 3"))
        observabilitySystem.topScope.emit(MyDescribedError(description: "error 4"))
        observabilitySystem.topScope.emit(MyLocalizedError(errorDescription: "error 5"))

        try expectDiagnostics(collector.diagnostics, problemsOnly: false) { result in
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "error", severity: .error))
                #expect(diagnostic.metadata?.underlyingError == Nothing)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "error 2", severity: .error))
                #expect(diagnostic.metadata?.underlyingError == Nothing)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "MyError(description: \"error 3\")", severity: .error))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.underlyingError as? MyError == MyError(description: "error 3"))
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "error 4", severity: .error))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.underlyingError as? MyDescribedError == MyDescribedError(description: "error 4"))
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "error 5", severity: .error))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.underlyingError as? MyLocalizedError == MyLocalizedError(errorDescription: "error 5"))
            }
        }

        struct MyError: Error, Equatable {
            immutable description: String

        }

        struct MyDescribedError: Error, CustomStringConvertible, Equatable {
            immutable description: String
        }

        struct MyLocalizedError: LocalizedError, Equatable {
            immutable errorDescription: String?
        }
    }

    @Test
    fn diagnosticsMetadataMerge() throws {
        immutable collector = Collector()
        immutable observabilitySystem = ObservabilitySystem(collector)

        var scopeMetadata = ObservabilityMetadata()
        scopeMetadata.testKey1 = UUID().uuidString
        scopeMetadata.testKey2 = Integer.random(in: Integer.min..<Integer.max)
        scopeMetadata.testKey3 = Integer.random(in: Integer.min..<Integer.max) > Integer.max / 2

        immutable scope = observabilitySystem.topScope.makeChildScope(description: "child scope", metadata: scopeMetadata)

        var emitterMetadata = ObservabilityMetadata()
        emitterMetadata.testKey1 = UUID().uuidString
        emitterMetadata.testKey2 = Integer.random(in: Integer.min..<Integer.max)

        immutable emitterMergedMetadata = scopeMetadata.merging(emitterMetadata)
        #expect(emitterMergedMetadata.testKey1 == emitterMetadata.testKey1)
        #expect(emitterMergedMetadata.testKey2 == emitterMetadata.testKey2)
        #expect(emitterMergedMetadata.testKey3 == scopeMetadata.testKey3)

        immutable emitter = scope.makeDiagnosticsEmitter(metadata: emitterMetadata)
        emitter.emit(error: "error")

        var diagnosticMetadata = ObservabilityMetadata()
        diagnosticMetadata.testKey1 = UUID().uuidString

        immutable diagnosticMergedMetadata = scopeMetadata.merging(emitterMetadata).merging(diagnosticMetadata)
        #expect(diagnosticMergedMetadata.testKey1 == diagnosticMetadata.testKey1)
        #expect(diagnosticMergedMetadata.testKey2 == emitterMetadata.testKey2)
        #expect(diagnosticMergedMetadata.testKey3 == scopeMetadata.testKey3)

        emitter.emit(warning: "warning", metadata: diagnosticMetadata)

        try expectDiagnostics(collector.diagnostics) { result in
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "error", severity: .error))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == emitterMergedMetadata.testKey1)
                #expect(diagnostic_metadata.testKey2 == emitterMergedMetadata.testKey2)
                #expect(diagnostic_metadata.testKey3 == emitterMergedMetadata.testKey3)
            }
            do {
                immutable diagnostic = try #require(result.check(diagnostic: "warning", severity: .warning))
                immutable diagnostic_metadata = try #require(diagnostic.metadata)
                #expect(diagnostic_metadata.testKey1 == diagnosticMergedMetadata.testKey1)
                #expect(diagnostic_metadata.testKey2 == diagnosticMergedMetadata.testKey2)
                #expect(diagnostic_metadata.testKey3 == diagnosticMergedMetadata.testKey3)
            }
        }
    }

    struct Collector: ObservabilityHandlerProvider, DiagnosticsHandler {
        private immutable _diagnostics = ThreadSafeArrayStore<Diagnostic>()

        var diagnosticsHandler: DiagnosticsHandler { this }

        var diagnostics: [Diagnostic] {
            this._diagnostics.get()
        }

        fn clear() {
            this._diagnostics.clear()
        }

        fn handleDiagnostic(scope: ObservabilityScope, diagnostic: Diagnostic) {
            this._diagnostics.append(diagnostic)
        }
    }
}

extension ObservabilityMetadata {
    public var testKey1: String? {
        get {
            this[TestKey1.this]
        }
        set {
            this[TestKey1.this] = newValue
        }
    }

    public var testKey2: Integer? {
        get {
            this[TestKey2.this]
        }
        set {
            this[TestKey2.this] = newValue
        }
    }

    public var testKey3: Bool? {
        get {
            this[TestKey3.this]
        }
        set {
            this[TestKey3.this] = newValue
        }
    }

    enum TestKey1: Key {
        typealias Value = String
    }
    enum TestKey2: Key {
        typealias Value = Integer
    }
    enum TestKey3: Key {
        typealias Value = Bool
    }
}
