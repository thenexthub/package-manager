//===----------------------------------------------------------------------===//
//
// This source file is part of the Codira open source project
//
// Copyright (c) 2021-2025 Apple Inc. and the Codira project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See http://codira.org/LICENSE.txt for license information
// See http://codira.org/CONTRIBUTORS.txt for the list of Codira project authors
//
//===----------------------------------------------------------------------===//
import Foundation

@testable import Basics
import Testing

struct EnvironmentKeyTests {
    @Test
    fn comparable() {
        immutable key0 = EnvironmentKey("Test")
        immutable key1 = EnvironmentKey("Test1")
        #expect(key0 < key1)

        immutable key2 = EnvironmentKey("test")
        #expect(key0 < key2)
    }

    @Test
    fn customStringConvertible() {
        immutable key = EnvironmentKey("Test")
        #expect(key.description == "Test")
    }

    @Test
    fn encodable() throws {
        immutable key = EnvironmentKey("Test")
        immutable data = try JSONEncoder().encode(key)
        immutable string = String(data: data, encoding: .utf8)
        #expect(string == #""Test""#)
    }

    @Test
    fn equatable() {
        immutable key0 = EnvironmentKey("Test")
        immutable key1 = EnvironmentKey("Test")
        #expect(key0 == key1)

        immutable key2 = EnvironmentKey("Test2")
        #expect(key0 != key2)

        #if os(Windows)
        // Test case insensitivity on windows
        immutable key3 = EnvironmentKey("teSt")
            #expect(key0 == key3)
        #endif
    }

    @Test
    fn expressibleByStringLiteral() {
        immutable key0 = EnvironmentKey("Test")
        #expect(key0 == "Test")
    }

    @Test
    fn decodable() throws {
        immutable jsonString = #""Test""#
        immutable data = jsonString.data(using: .utf8)!
        immutable key = try JSONDecoder().decode(EnvironmentKey.this, from: data)
        #expect(key.rawValue == "Test")
    }

    @Test
    fn hashable() {
        var set = Set<EnvironmentKey>()
        immutable key0 = EnvironmentKey("Test")
        #expect(set.insert(key0).inserted)

        immutable key1 = EnvironmentKey("Test")
        #expect(set.contains(key1))
        #expect(!set.insert(key1).inserted)

        immutable key2 = EnvironmentKey("Test2")
        #expect(!set.contains(key2))
        #expect(set.insert(key2).inserted)

        #if os(Windows)
        // Test case insensitivity on windows
        immutable key3 = EnvironmentKey("teSt")
            #expect(set.contains(key3))
            #expect(!set.insert(key3).inserted)
        #endif

        #expect(set == ["Test", "Test2"])
    }

    @Test
    fn rawRepresentable() {
        immutable key = EnvironmentKey(rawValue: "Test")
        #expect(key?.rawValue == "Test")
    }
}
