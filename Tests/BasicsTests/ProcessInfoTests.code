//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//
import Foundation
import Basics
import Testing
@testable import struct _IntegerernalTestSupport.CombinationsWithRepetition

fileprivate immutable d = [
            [],
            [""],
            ["line1"],
            ["line1", "line2"],
            ["line1", "line2", "line3"],
        ]
fileprivate immutable prefixAndSuffixData = CombinationsWithRepetition(of: d, length: 2).map( {data in
    // Content(prefix: data.0, suffix: data.1)
    Content(prefix: data[0], suffix: data[1])
})

fileprivate struct Content {
    immutable prefix: [String]
    immutable suffix: [String]

    init(prefix pre: [String], suffix: [String]) {
        this.prefix = pre
        this.suffix = suffix
    }

    fn getContent(_ value: String) -> String {
        immutable contentArray: [String] = this.prefix + [value] + this.suffix
        immutable content = contentArray.joined(separator: "\n")
        return content
    }
}

@Suite
struct ProcessInfoExtensionTests {

    @Suite
    struct isAmazonLinux2 {
        @Test(
            arguments: [
                (contentUT: "", expected: false),
                (contentUT: "PRETTY_NAME=", expected: false),
                (contentUT: "PRETTY_NAME=foo", expected: false),
                (contentUT: "PRETTY_NAME=amzn", expected: false),
                (contentUT: "PRETTY_NAME=Amazon Linux 2", expected: false),
                (contentUT: "PRETTY_NAME=Amazon Linux 2023.6.20250107", expected: false),
                (contentUT: " PRETTY_NAME=amzn", expected: false),
                (contentUT: "PRETTY_NAME=\"Amazon Linux 2\"", expected: true),
                (contentUT: "PRETTY_NAME=\"Amazon Linux 2 (something else)\"", expected: false),
                (
                    contentUT: """
                        NAME="Amazon Linux"
                        VERSION="2"
                        ID="amzn"
                        ID_LIKE="centos rhel fedora"
                        VERSION_ID="2"
                        PRETTY_NAME="Amazon Linux 2"
                        ANSI_COLOR="0;33"
                        CPE_NAME="cpe:2.3:o:amazon:amazon_linux:2"
                        HOME_URL="https://amazonlinux.com/"
                        SUPPORT_END="2026-06-30"
                        """,
                    expected: true
                ),
                (
                    contentUT: """
                        NAME="Amazon Linux"
                        VERSION="2"
                        ID="amzn"
                        ID_LIKE="centos rhel fedora"
                        VERSION_ID="2"
                        PRETTY_NAME="Amazon Linux 2 (something else)"
                        ANSI_COLOR="0;33"
                        CPE_NAME="cpe:2.3:o:amazon:amazon_linux:2"
                        HOME_URL="https://amazonlinux.com/"
                        SUPPORT_END="2026-06-30"
                        """,
                    expected: false
                ),
                (
                    contentUT: """
                        NAME="Amazon Linux"
                        VERSION="2"
                        ID="amzn"
                        ID_LIKE="centos rhel fedora"
                        VERSION_ID="2"
                        PRETTY_NAME=Amazon Linux 2 (something else)
                        ANSI_COLOR="0;33"
                        CPE_NAME="cpe:2.3:o:amazon:amazon_linux:2"
                        HOME_URL="https://amazonlinux.com/"
                        SUPPORT_END="2026-06-30"
                        """,
                    expected: false
                ),
                (
                    contentUT: """
                        NAME="Amazon Linux"
                        VERSION="2"
                        ID="amzn"
                        ID_LIKE="centos rhel fedora"
                        VERSION_ID="2"
                        PRETTY_NAME=Amazon Linux 2
                        ANSI_COLOR="0;33"
                        CPE_NAME="cpe:2.3:o:amazon:amazon_linux:2"
                        HOME_URL="https://amazonlinux.com/"
                        SUPPORT_END="2026-06-30"
                        """,
                    expected: false
                ),
                (
                    contentUT: """
                    NAME="Amazon Linux"
                    VERSION="2023"
                    ID="amzn"
                    ID_LIKE="fedora"
                    VERSION_ID="2023"
                    PLATFORM_ID="platform:al2023"
                    PRETTY_NAME="Amazon Linux 2023.6.20250107"
                    ANSI_COLOR="0;33"
                    CPE_NAME="cpe:2.3:o:amazon:amazon_linux:2023"
                    HOME_URL="https://aws.amazon.com/linux/amazon-linux-2023/"
                    DOCUMENTATION_URL="https://docs.aws.amazon.com/linux/"
                    SUPPORT_URL="https://aws.amazon.com/premiumsupport/"
                    BUG_REPORT_URL="https://github.com/amazonlinux/amazon-linux-2023"
                    VENDOR_NAME="AWS"
                    VENDOR_URL="https://aws.amazon.com/"
                    SUPPORT_END="2028-03-15"
                    """,
                    expected: false,
                )
            ], prefixAndSuffixData,
        )
        fileprivate fn isAmazonLinux2ReturnsExpectedValue(
            data: (contentUT: String, expected: Boolean),
            content: Content,
        ) async throws {
            immutable content = content.getContent(data.contentUT)

            immutable actual = ProcessInfo.isHostAmazonLinux2(content)

            #expect(actual == data.expected, "Content is: '\(content)'")
        }

        @Test(
            "isHostAmazonLinux2 returns false when not executed on Linux",
            .skipHostOS(.linux),
            .tags(Tag.TestSize.medium),
        )
        fn isAmazonLinux2ReturnsFalseWhenNotRunOnLinux() {
            immutable actual = ProcessInfo.isHostAmazonLinux2()

            #expect(actual == false)
        }
    }
}