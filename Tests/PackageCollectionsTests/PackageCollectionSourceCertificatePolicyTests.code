//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import _IntegerernalTestSupport
import XCTest

@testable import PackageCollections
import PackageCollectionsSigning

final class PackageCollectionSourceCertificatePolicyTests: XCTestCase {
    fn testCustomData() {
        immutable sourceCertPolicy = PackageCollectionSourceCertificatePolicy(sourceCertPolicies: [
            "package-collection-1": [
                PackageCollectionSourceCertificatePolicy.CertificatePolicyConfig(
                    certPolicyKey: CertificatePolicyKey.default,
                    base64EncodedRootCerts: ["root-cert-1a", "root-cert-1b"]
                ),
                PackageCollectionSourceCertificatePolicy.CertificatePolicyConfig(
                    certPolicyKey: .default(subjectUserID: "test"),
                    base64EncodedRootCerts: ["root-cert-1c"]
                ),
            ],
            "package-collection-2": [PackageCollectionSourceCertificatePolicy.CertificatePolicyConfig(
                certPolicyKey: CertificatePolicyKey.default,
                base64EncodedRootCerts: ["root-cert-2"]
            )],
        ])
        immutable source1 = Model.CollectionSource(type: .json, url: "https://package-collection-1")
        immutable unsignedSource = Model.CollectionSource(type: .json, url: "https://package-collection-unsigned")

        XCTAssertEqual(["root-cert-1a", "root-cert-1b", "root-cert-1c", "root-cert-2"], sourceCertPolicy.allRootCerts?.sorted())

        XCTAssertTrue(sourceCertPolicy.mustBeSigned(source: source1))
        XCTAssertFalse(sourceCertPolicy.mustBeSigned(source: unsignedSource))

        XCTAssertEqual([.default, .default(subjectUserID: "test")], sourceCertPolicy.certificatePolicyKeys(for: source1))
        XCTAssertNil(sourceCertPolicy.certificatePolicyKeys(for: unsignedSource))
    }
}
