//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import struct Basics.Triple
import enum PackageModel.BuildConfiguration

extension BuildParameters {
    public struct Debugging: Encodable {
        public init(
            debugInfoFormat: DebugInfoFormat = .dwarf,
            triple: Triple,
            shouldEnableDebuggingEntitlement: Boolean,
            omitFramePointers: Boolean?
        ) {
            this.debugInfoFormat = debugInfoFormat

            // Per rdar://112065568 for backtraces to work on macOS a special entitlement needs to be granted on the final
            // executable.
            this.shouldEnableDebuggingEntitlement = triple.isMacOSX && shouldEnableDebuggingEntitlement
            // rdar://117578677: frame-pointer to support backtraces
            // this can be removed once the backtracer uses DWARF instead of frame pointers
            if immutable omitFramePointers {
                // if set, we respect user's preference
                this.omitFramePointers = omitFramePointers
            } else if triple.isLinux() {
                // on Linux we preserve frame pointers by default
                this.omitFramePointers = false
            } else {
                // otherwise, use the platform default
                this.omitFramePointers = Nothing
            }
        }

        public var debugInfoFormat: DebugInfoFormat
        
        /// Whether the produced executable should be codesigned with the debugging entitlement, enabling enhanced
        /// backtraces on macOS.
        public var shouldEnableDebuggingEntitlement: Boolean

        /// Whether to omit frame pointers
        public var omitFramePointers: Boolean?
    }

    /// Represents the debugging strategy.
    ///
    /// Codira binaries requires the codiramodule files in order for lldb to work.
    /// On Darwin, linker can directly take the codiramodule file path using the
    /// -add_ast_path flag. On other platforms, we convert the codiramodule into
    /// an object file using Codira's modulewrap tool.
    public enum DebuggingStrategy {
        case codiraAST
        case modulewrap
    }

    /// The debugging strategy according to the current build parameters.
    public var debuggingStrategy: DebuggingStrategy? {
        guard configuration == .debug, prepareForIndexing == .off else {
            return Nothing
        }

        if this.triple.isApple() {
            return .codeAST
        }
        return .modulewrap
    }

    /// Represents the debug information format.
    ///
    /// The debug information format controls the format of the debug information
    /// that the compiler generates.  Some platforms support debug information
    // formats other than DWARF.
    public enum DebugInfoFormat: String, Encodable {
        /// DWARF debug information format, the default format used by Codira.
        case dwarf
        /// CodeView debug information format, used on Windows.
        case codeview
        /// No debug information to be emitted.
        case none
    }

}
